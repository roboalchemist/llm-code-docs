<!-- Source: https://github.com/siyuan-note/user-guide-en_US/blob/master/20200923234011-ieuun1p/20210808180303-v9awwp0/20210721112206-mhr9wxi.sy -->

# Data Sync

## Overview

Data synchronization refers to keeping the `workspace/data/` folder data consistent on multiple devices, including asset files, templates, widgets, and notebook data.

## How to use

Open <kbd>Settings - Cloud - Cloud sync</kbd> and proceed through the synchronization setting wizard.

1. Set the end-to-end encryption password
2. Create or select a cloud synchronization directory. After selecting, the cloud synchronization directory will be used for data synchronization in the current workspace
3. Enable sync switch

Please perform the above operations on the *main* device first, then select the same cloud sync directory on other devices and turn on the sync switch. If you want to switch, rename or remove the cloud sync directory, please turn off the sync switch on all devices before proceeding.

## Ignore files

If you need to ignore some files during synchronization, please create or edit the text file `workspace/data/.siyuan/syncignore` on the file system, each line is configured with the relative path of the data folder, which means that the path of the file or folder is ignored and wildcard characters are supported. E.g:

- `20210808180117-6v0mkxr/**/*`: Ignore the data/20210808180117-6v0mkxr notebook
- `assets/*.pdf`: ignore PDF files under data/assets/

## Working principle

SiYuan performs corresponding operations by comparing the cloud data version and the local data version:

- Skip if the version is equal
- If the cloud version is greater than the local version, download the cloud data locally and decrypt it to the `workspace/data/` folder, and the local overwritten or deleted files will be moved to the `workspace/history/` folder
- If the cloud version is less than the local version, scan for changes in `/workspace/data/`, then encrypt the changes and copy them to the folder `workspace/sync/`, and finally upload and overwrite the cloud data

The version comparison is automatically performed at regular intervals. The time interval algorithm is described as follows:

- After 30 seconds of data change, if there is no further change, a comparison will be made, and if it continues to change, it will be delayed by 30 seconds
- If there is no data change, it will be incremented by 5 minutes, 8 minutes, 16 minutes, 32 minutes...

## Scenario example

From the above working principle, we can know that SiYuan only supports alternate synchronization of data on multiple devices: after synchronization is completed on device A, synchronization is performed on device B. Simultaneous synchronization of multiple devices cannot be supported, so unexpected data overwriting will occur.

### Normal scene

1. Execute synchronization after editing on device A (by triggering synchronization automatically or manually), at this time, the cloud data will be overwritten by the data of device A, that is, the cloud and device A keep the same data
2. Execute synchronization on device B. At this time, the data of device B will be overwritten by the cloud data, that is, the cloud and devices A and B keep the same data
3. After editing on device B, perform synchronization again. At this time, the cloud data will be overwritten by device B data, that is, the cloud and device B keep the same data.
4. Execute synchronization on device A. At this time, the data of device A will be overwritten by the cloud data, that is, the cloud and devices A and B keep the same data

In this scenario, the process of using synchronization is performed alternately on devices A and B, which can ensure that data synchronization is completed normally as expected.

### Override scene

1. Not syncing after editing on device A (for example, when there is no network and it is offline)
2. Not syncing after editing on device B
3. Perform synchronization on device A. At this time, the cloud data will be overwritten by the data of device A, that is, the cloud and device A keep the same data.
4. Perform a sync on device B, at which point there are three possible scenarios
  - Device B data skip synchronization because the version and cloud are the same
  - Device B data covers the cloud
  - Device B data is overwritten by the cloud

In this scenario, the process of using synchronization is to edit offline on both devices, and then perform synchronization, so that the expected results of normal synchronization cannot be obtained. Even so, the data will not be lost, and the overwritten data can be retrieved through history.

## Note

- Synchronization will not be triggered in the case of sudden disconnection such as sleep or shutdown, please manually click the synchronization button to synchronize
- Before renaming or deleting the cloud directory, please turn off synchronization on all devices before editing or deleting
- Do not use a third-party sync disk and SiYuan sync at the same time, it may cause data damage
- Symbolic links will not be synchronized
