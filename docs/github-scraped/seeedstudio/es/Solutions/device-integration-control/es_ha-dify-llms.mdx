---
description: Usar Dify, el servicio backend Xiaozhi, y el SenseCAP Watcher para integrar un asistente de IA‚Äîcapaz de comprensi√≥n contextual, control de dispositivos, consultas de estado‚Äîen tu asistente dom√©stico.
title: Integrar Mayordomo de IA Espacial en Home Assistant
keywords:
- Home Assistant
- Jarvis
- SenseCAP Watcher
- xiaozhi
- AI
- LLM
- Chat-Bot
image: https://files.seeedstudio.com/wiki/solution/application/dify-ha-mcp/xiaozhi_sensecap_watcher.jpg
slug: /es/ha_dify_watcher_llms
sidebar_position: 1
last_update:
  date: 05/11/2025
  author: Spencer
---

import { Tweet } from 'react-tweet'
import LoomEmbed from '@site/src/components/utils/LoomEmbed';

:::info Construye un asistente de IA controlado por voz para tu hogar inteligente.
Imagina poder comenzar tu d√≠a simplemente susurrando a un dispositivo junto a tu cama: "Jarvis, buenos d√≠as. ¬øC√≥mo est√° el clima hoy? Y por favor, enciende la cafetera." En respuesta, tu asistente de IA confirma el pron√≥stico del tiempo mientras tu cafetera comienza a preparar caf√© en la cocina.

Esto no es solo un concepto de una pel√≠cula; es una aplicaci√≥n pr√°ctica que puedes construir e implementar t√∫ mismo. Esta gu√≠a proporciona una soluci√≥n paso a paso para integrar un asistente de IA local con tus dispositivos dom√©sticos inteligentes. Al final de este tutorial, tendr√°s un centro dom√©stico inteligente completamente funcional y activado por voz.
:::

<center>
<Tweet id="1910315965675712738" /> 
</center>

Este art√≠culo proporcionar√° una gu√≠a paso a paso sobre c√≥mo usar Dify, el servicio backend Xiaozhi, y el SenseCAP Watcher para integrar un asistente de IA‚Äîcapaz de comprensi√≥n contextual, control de dispositivos, consultas de estado, e incluso preguntas y respuestas basadas en conocimiento‚Äîen tu sistema dom√©stico inteligente Home Assistant. Aprender√°s c√≥mo hacer que la IA sea un asistente verdaderamente efectivo en tu vida inteligente a trav√©s de simples interacciones de voz.

## Prerrequisitos

Por favor, ten listos los siguientes elementos y condiciones:

| Dispositivo | Prop√≥sito |
| :--- | :--- |
| Home Assistant Green | Un sistema Home Assistant pre-implementado |
| ReComputer R1000 | Para implementar Dify, el servicio Xiaozhi, e interactuar con el Watcher |
| SenseCAP Watcher | La interfaz de interacci√≥n humano-m√°quina |
| Una computadora | Para acceder a las aplicaciones instaladas |

Adem√°s, se requiere una conexi√≥n de red estable.

## ‚Ö†. Instalaci√≥n y Despliegue

En esta secci√≥n, instalaremos y configuraremos los componentes principales en tres pasos:

1.  Instalar Dify - El cerebro de la aplicaci√≥n de IA
2.  Instalar `xiaozhi-esp32-server` - El puente que conecta la IA y el hardware
3.  Configurar SenseCAP Watcher - Permitir que el asistente de voz te escuche

Puedes omitir los siguientes pasos e ir a [Orquestaci√≥n de la Aplicaci√≥n Dify](https://www.google.com/search?q=%23dify-app) si ya has instalado y configurado Dify, el servicio backend de Xiaozhi, y SenseCAP Watcher.

### Instalar Dify

> Por favor [instala Docker](https://docs.docker.com/engine/install/) primero si a√∫n no lo has hecho.

:::tip

Para usuarios en China continental, es posible que necesites actualizar la fuente de im√°genes de Docker:

`bash <(curl -sSL https://linuxmirrors.cn/docker.sh)`

Nota: Este script es proporcionado por un [tercero](https://linuxmirrors.cn/). Esta referencia es solo para fines de ejemplo. Por favor eval√∫a su idoneidad y riesgos por ti mismo.

:::

Ejecuta los siguientes comandos para instalar Dify. Para m√°s detalles, consulta [Instalaci√≥n de Dify](https://docs.dify.ai/en/getting-started/install-self-hosted/docker-compose):

```shell
git clone https://github.com/langgenius/dify.git --branch 1.5.0 # Download the code for Dify version 1.5.0, check the repo for the latest version.
cd dify/docker       # Change to the Docker configuration directory for Dify
cp .env.example .env # For beginners, no modification to this file is needed
docker compose up -d
```

Despu√©s de que los comandos se hayan ejecutado exitosamente, Dify deber√≠a estar funcionando. Ahora, necesitas encontrar la direcci√≥n IP de la computadora donde est√° ejecut√°ndose Docker.

:::tip Encontrar la Direcci√≥n IP

  - En Windows, abre el S√≠mbolo del sistema (CMD) o PowerShell, escribe `ipconfig`, y busca la "Direcci√≥n IPv4".
  - En macOS o Linux, abre la Terminal, escribe `ip addr` o `ifconfig`, y encuentra la direcci√≥n IP correspondiente a tu interfaz de red (usualmente comienza con `192.168.x.x` o `10.x.x.x`).

:::

Asumiendo que la direcci√≥n IP de tu computadora es `192.168.101.109`, abre un navegador y navega a `http://192.168.101.109/install` (la primera visita redirigir√° a la p√°gina de configuraci√≥n inicial).

Sigue las instrucciones en pantalla para completar la creaci√≥n de la cuenta de administrador. Despu√©s, puedes acceder al panel principal de Dify en `http://192.168.101.109`.

#### Configurar Proveedor de Modelo

Para permitir que tu aplicaci√≥n de IA de Dify piense y responda, necesitas conectarla a al menos un "Proveedor de Modelo de Lenguaje Grande."

  - Despu√©s de iniciar sesi√≥n en Dify, encuentra tu avatar de perfil en la barra de navegaci√≥n superior y haz clic en "Configuraci√≥n."
  - Selecciona "Proveedores de Modelo" del men√∫ de la izquierda.
  - Esto listar√° los varios proveedores de modelo soportados por Dify (como OpenAI, Azure OpenAI, Volcano Engine, MiniMax, etc.). Elige un proveedor con el que tengas una cuenta y desees usar, luego haz clic en "Agregar."
  - Sigue las indicaciones en pantalla para ingresar la informaci√≥n de autorizaci√≥n de tu proveedor de modelo, como la Clave API. Por ejemplo, esta gu√≠a usa "Volcano Engine" como proveedor de modelo.

![Dify MCP authorize](https://files.seeedstudio.com/wiki/solution/application/dify-ha-mcp/Model-supplier.png)

Para instrucciones detalladas, por favor consulta [Introducci√≥n a la Integraci√≥n de Modelos Grandes - Documentos de Dify](https://docs.dify.ai/zh-hans/guides/model-configuration/readme):

#### Crear una Nueva Aplicaci√≥n de Agente

En Dify, los asistentes de IA existen como "Aplicaciones." Necesitamos crear una aplicaci√≥n de tipo "Agente."

  - En el panel principal de Dify, haz clic en "Crear Aplicaci√≥n."
  - Selecciona el tipo de aplicaci√≥n como "Agente."
  - Dale un nombre a tu aplicaci√≥n (ej., "Mi Mayordomo Inteligente") y luego haz clic en "Crear."

#### Obtener la Clave API de la Aplicaci√≥n

Para permitir que el "servicio backend de Xiaozhi" se comunique con esta aplicaci√≥n de Dify, necesitamos obtener la clave API de la aplicaci√≥n.

  - Ve a la aplicaci√≥n de Agente que acabas de crear.
  - En la barra de navegaci√≥n izquierda dentro de la aplicaci√≥n, encuentra y haz clic en el √≠cono que parece una terminal, que es "Acceso API."
  - En la p√°gina de Acceso API, haz clic en "Clave API" en la esquina superior derecha, y luego haz clic en el bot√≥n "Crear Clave" que aparece.
  - El sistema generar√° una clave API (tambi√©n llamada Token), por ejemplo, `app-T9jHW9pCtj3NVMHHPAPrNFAg`.


:::note IMPORTANTE

Copia esta clave API inmediatamente y p√©gala en un lugar seguro (como un bloc de notas), ya que la necesitaremos en breve.

:::

<LoomEmbed
  id="b2f1c852b0e04ad383f894b5b105985d"
  sid="c56f7759-a7cc-4000-856a-ff88d11a6910"
  muted={true}
  autoplay={false}
/>

### Instalar el Servicio Backend de Xiaozhi

El servicio backend de Xiaozhi es un programa dise√±ado espec√≠ficamente para la serie de microcontroladores ESP32 (el SenseCAP Watcher est√° basado en el ESP32-S3). Recibe datos de voz del hardware, realiza reconocimiento, y los reenv√≠a a la aplicaci√≥n de IA que acabamos de crear en Dify.

El servicio backend de Xiaozhi ofrece dos m√©todos de instalaci√≥n: instalaci√≥n simplificada e instalaci√≥n de m√≥dulo completo. Para detalles, por favor consulta [Elegir un M√©todo de Despliegue](https://github.com/xinnan-tech/xiaozhi-esp32-server#-%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F%E9%80%89%E6%8B%A9).

Recomendamos la instalaci√≥n `full-module` para una experiencia m√°s conveniente.

Ejecuta el siguiente script de instalaci√≥n r√°pida:

```bash
curl -L -o xiaozhi-server-docker-setup.sh https://raw.githubusercontent.com/xinnan-tech/xiaozhi-esp32-server/main/docker-setup.sh
chmod +x xiaozhi-server-docker-setup.sh
./xiaozhi-server-docker-setup.sh
```

Despu√©s de que el script termine de ejecutarse, crear√° una carpeta llamada `xiaozhi-server` en el directorio actual y descargar√° autom√°ticamente los archivos necesarios para el servicio backend de Xiaozhi y los modelos b√°sicos de reconocimiento de voz.

Para la experiencia funcional completa, necesitamos instalar usando el archivo de configuraci√≥n de m√≥dulos completos. Por favor, ejecuta el siguiente comando nuevamente:

```bash
cd xiaozhi-server
wget https://raw.githubusercontent.com/xinnan-tech/xiaozhi-esp32-server/refs/heads/main/main/xiaozhi-server/docker-compose_all.yml
wget https://raw.githubusercontent.com/xinnan-tech/xiaozhi-esp32-server/refs/heads/main/main/xiaozhi-server/config_from_api.yaml
mv data/.config.yaml data/.config.yaml.bk
mv config_from_api.yaml data/.config.yaml
```

Ahora, intenta iniciar el contenedor para el servicio backend completo de Xiaozhi:

```bash
docker compose -f docker-compose_all.yml up -d
```

Una vez completado, ejecuta el siguiente comando para ver la informaci√≥n de registro.

```bash
docker logs -f xiaozhi-esp32-server-web
```

Cuando veas la salida del log, significa que tu consola de control se ha iniciado exitosamente.

```shell
2025-xx-xx 22:11:12.445 [main] INFO  c.a.d.s.b.a.DruidDataSourceAutoConfigure - Init DruidDataSource
2025-xx-xx 21:28:53.873 [main] INFO  xiaozhi.AdminApplication - Started AdminApplication in 16.057 seconds (process running for 17.941)
http://localhost:8002/xiaozhi/doc.html
```

Ahora, puedes visitar `http://localhost:8002` para iniciar sesi√≥n en la consola de control y registrar el primer usuario. El primer usuario ser√° el superadministrador; los usuarios regulares posteriores solo pueden ser creados por el superadministrador.

<details>

<summary>Resolver conflictos de puertos del servicio Docker</summary>

El servicio backend de Xiaozhi utiliza varios puertos de red por defecto (por ejemplo, el servicio WebSocket mapea el puerto 8000 de la m√°quina host al puerto 8000 del contenedor por defecto). Si estos puertos ya est√°n siendo utilizados por otros programas en tu computadora, el comando `docker compose up -d` puede fallar con un error de conflicto de puertos.

En este caso, necesitas editar el archivo `docker-compose_all.yml` ubicado en la carpeta `xiaozhi-server`.

Encuentra las secciones `ports:` para ambos servicios `xiaozhi-esp32-server` y `xiaozhi-esp32-server-web`, por ejemplo:

```yaml
xiaozhi-esp32-server:
  ports:
    - "8088:8000" # The left is the host port, the right is the container port
xiaozhi-esp32-server-web:
  ports:
    - "8002:8002"
```

  - Si el puerto `8000` entra en conflicto, puedes cambiarlo a otro puerto no utilizado, como `8088`, por lo que la configuraci√≥n se convierte en `- "8088:8000"`. Guarda el archivo despu√©s de hacer el cambio y ejecuta `docker compose up -d` nuevamente.
  - **Nota**: Si cambias el puerto del host aqu√≠ (por ejemplo, de `8000` a `8088`), entonces debes usar el n√∫mero de puerto nuevo correspondiente al configurar `/data.config.yaml` y el SenseCAP Watcher.

</details>

#### Paso 1: Gesti√≥n de Par√°metros

Despu√©s de iniciar sesi√≥n con la cuenta de superadministrador, navega a "Gesti√≥n de Par√°metros" en el men√∫ superior de la consola de control. Encuentra el primer elemento en la lista, que tiene el c√≥digo de par√°metro `server.secret`, y copia su "Valor de Par√°metro".

Modifica el archivo `.config.yaml` en el directorio `data` bajo `xiaozhi-server`. Encuentra el elemento de configuraci√≥n `manager-api` y cambia el valor `secret` al valor de par√°metro que acabas de copiar.
Al mismo tiempo, cambia la URL a `http://xiaozhi-esp32-server-web:8002/xiaozhi`.

```yaml
manager-api:
  url: http://xiaozhi-esp32-server-web:8002/xiaozhi
  secret: 12345678-xxxx-xxxx-xxxx-123456789000 # Please replace this with your server.secret value
```

#### Paso 2: Configurar la Comunicaci√≥n Entre Contenedores

Dado que Dify y el servicio backend de Xiaozhi se inician por separado a trav√©s de Docker, pueden estar en diferentes "redes virtuales" por defecto y no pueden comunicarse directamente. Necesitamos conectar el contenedor del servicio API de Dify a la red del servicio de Xiaozhi.

```shell
docker network connect xiaozhi-server_default docker-api-1
```

Despu√©s de este comando, el servicio Xiaozhi puede acceder al servicio de API de Dify en la direcci√≥n `http://dify-api-1:5001/v1`.

<details>

<summary>¬øPor qu√© no usar host.docker.internal?</summary>

Podr√≠as considerar usar `host.docker.internal` (un nombre DNS especial para acceder al host desde dentro de un contenedor de Docker) como soluci√≥n de conexi√≥n. Sin embargo, ten en cuenta que si el servicio `docker-api-1` (el contenedor de API de Dify) no mapea su puerto al host, o si el servicio en s√≠ no escucha directamente en la interfaz de red del host, el contenedor `xiaozhi-server` no podr√° acceder exitosamente a `docker-api-1` a trav√©s de `host.docker.internal:5001`. Por lo tanto, asegurar que ambos contenedores est√©n en la misma red de Docker y se comuniquen a trav√©s de nombres de servicio es el m√©todo de configuraci√≥n m√°s recomendado y confiable, especialmente cuando el servicio `docker-api-1` opera principalmente dentro de la red del contenedor.

</details>

#### Paso 3: Reiniciar xiaozhi-esp32-server

Despu√©s de configurar la informaci√≥n anterior, necesitas reiniciar el servicio backend de Xiaozhi para que los cambios surtan efecto. Esto se debe a que el proceso de instalaci√≥n utiliza el `server.secret` para conectarse al servicio.

```bash
docker restart xiaozhi-esp32-server
```

Verificar los registros del servicio backend de Xiaozhi (Opcional):

Si deseas confirmar que el servicio Xiaozhi se ha iniciado y est√° funcionando correctamente, puedes ejecutar el siguiente comando para ver los registros en tiempo real:

```
docker logs -f xiaozhi-esp32-server
```

(`xiaozhi-esp32-server` es el nombre predeterminado del contenedor de servicio. Presiona `Ctrl+C` para salir de la vista de registros.)

Si ves registros similares a los siguientes, indica que el servidor se ha iniciado exitosamente.

```shell
25-02-23 12:01:09[core.websocket_server] - INFO - Websocket address is      ws://xxx.xx.xx.xx:8000/xiaozhi/v1/
25-02-23 12:01:09[core.websocket_server] - INFO - =======The address above is a websocket protocol address, please do not access it with a browser=======
25-02-23 12:01:09[core.websocket_server] - INFO - To test the websocket, please open test_page.html in the test directory with Google Chrome
25-02-23 12:01:09[core.websocket_server] - INFO - =======================================================
```

Asumiendo que la direcci√≥n IP de tu computadora es `192.168.101.109`, las interfaces OTA y WebSocket de tu servicio backend de Xiaozhi ahora deber√≠an ser:

Interfaz OTA:

```bash
http://192.168.101.109:8002/xiaozhi/ota/
```

Interfaz WebSocket:

```html
ws://192.168.101.109:8000/xiaozhi/v1/
```

> Recuerda reemplazar `192.168.101.109` con la direcci√≥n IP donde se est√° ejecutando tu servicio Xiaozhi.

#### Paso 4: Configurar el Servicio para Conectarse a Dify

Necesitamos indicar al servicio backend de Xiaozhi c√≥mo encontrar y usar la aplicaci√≥n de IA que creamos en Dify. Esto implica enrutar todas las solicitudes LLM a Dify modificando la configuraci√≥n del modelo de lenguaje grande.

Inicia sesi√≥n nuevamente en la consola de control del servicio backend de Xiaozhi. En el men√∫ superior, encuentra "Configuraci√≥n de Modelo", luego haz clic en "Modelos de Lenguaje Grande" en la barra lateral izquierda. Encuentra la primera entrada, "Dify", y haz clic en el bot√≥n modificar. En el di√°logo emergente, completa la Clave API de la aplicaci√≥n que creaste en Dify. Tambi√©n, cambia la URL Base a `http://dify-api-1:5001/v1`.

> [\!tip]
> Tambi√©n puedes crear m√∫ltiples aplicaciones Dify y luego configurar m√∫ltiples modelos de lenguaje grande Dify en la consola de control.

#### Paso 5: Agregar Agente

Haz clic en "Agentes" en el men√∫ superior, luego haz clic en "Agregar Agente". Ingresa cualquier nombre, por ejemplo, `Dify_Agent`.

Para el `Dify_Agent` reci√©n agregado, haz clic en "Configurar Rol" para ingresar a la configuraci√≥n de rol. Luego, en la barra lateral derecha, cambia el "Modelo de Lenguaje Grande (LLM)" a "Dify" (la conexi√≥n Dify que configuraste anteriormente). Modifica otras funciones seg√∫n sea necesario y haz clic en "Guardar Configuraci√≥n".

Usaremos esto en la siguiente secci√≥n al configurar el asistente Watcher.

## ‚Ö°. Configurar SenseCAP Watcher

Ahora, necesitamos configurar el dispositivo SenseCAP Watcher, para que sepa d√≥nde conectarse al servicio backend de Xiaozhi que acabamos de configurar.

:::note Nota
Esta gu√≠a usa la versi√≥n `1.6.2` del [Xiaozhi AI Chatbot](https://github.com/78/xiaozhi-esp32) para el SenseCAP Watcher. Si est√°s usando una versi√≥n diferente, es posible que necesites ajustar la configuraci√≥n en consecuencia.
:::

### Modificar la Direcci√≥n OTA

Enciende el SenseCAP Watcher y con√©ctate a su red WiFi desde cualquier dispositivo.

Despu√©s de conectarte exitosamente, visita `192.168.4.1` para configurar la conexi√≥n WiFi y la direcci√≥n OTA.

La direcci√≥n OTA debe ser:

```bash
http://<IP_Address>:<Port_Number>/xiaozhi/ota/
```

  - **`<IP_Address>`**: Reemplaza esto con la direcci√≥n IP de la red local de la computadora que ejecuta el servicio backend de Xiaozhi (por ejemplo, `192.168.101.109`).
  - **`<Port_Number>`**: Reemplaza esto con el n√∫mero de puerto OTA expuesto por el servicio backend de Xiaozhi. Si no modificaste el archivo `docker-compose.yaml` para `xiaozhi-server` anteriormente, esto ser√° `8002`. Si lo cambiaste (por ejemplo, a `8088`), debes usar tu n√∫mero de puerto modificado aqu√≠.

Por ejemplo:

```
http://192.168.101.109:8002/xiaozhi/ota/
```

Despu√©s de completar la configuraci√≥n y confirmar, el dispositivo se reiniciar√° autom√°ticamente e intentar√° conectarse al servicio backend de Xiaozhi.

Una vez que se conecte exitosamente al servicio OTA, el dispositivo Watcher anunciar√° un c√≥digo de verificaci√≥n.

Luego, en la consola de control, bajo el `Dify_Agent` que creaste, haz clic en "Gesti√≥n de Dispositivos". Haz clic en "Agregar Nuevo", ingresa el c√≥digo de verificaci√≥n anunciado por el dispositivo y haz clic en "Guardar".

Despu√©s de completar la configuraci√≥n como se describe arriba, el Watcher podr√° conectarse al servicio backend de Xiaozhi.

üéâ En este punto, toda la instalaci√≥n de software y configuraci√≥n b√°sica de hardware est√°n completas\! A continuaci√≥n, nos enfocaremos en "orquestar" nuestra aplicaci√≥n de IA en la plataforma Dify, permiti√©ndole entender y responder a nuestros comandos de control de hogar inteligente.

## ‚Ö¢. Orquestaci√≥n de Aplicaci√≥n Dify {#dify-app}

Regresemos a la plataforma Dify y configuremos la aplicaci√≥n Agent que creamos anteriormente para permitirle comunicarse con Home Assistant y entender nuestros comandos.

### ‚Ö†. Agregar la Herramienta MCP

Para permitir que Dify controle dispositivos en Home Assistant, necesitamos agregarle una "Herramienta". Esta herramienta est√° basada en el MCP (Meta Control Protocol).

En la barra de navegaci√≥n superior de la p√°gina de la aplicaci√≥n Dify, encuentra la opci√≥n "**Tools**", busca "**MCP SSE**" y descarga el plugin correspondiente.

![](https://files.seeedstudio.com/wiki/solution/application/dify-ha-mcp/Install-MCP.png)

#### Configurar la Herramienta MCP para Conectar a HA

Despu√©s de la instalaci√≥n, haz clic en esta herramienta nuevamente. Te pedir√° que proporciones informaci√≥n de configuraci√≥n del servicio MCP para que Dify pueda comunicarse con √©l v√≠a MCP. Siguiendo la plantilla y la documentaci√≥n de [MCP Server - Home Assistant](https://www.home-assistant.io/integrations/mcp_server/), t√≠picamente necesitar√°s ingresar una configuraci√≥n en formato JSON similar a la siguiente:

```json
{
  "Home Assistant": {
      "url": "http://your_ha_ip:8123/mcp_server/sse",
      "headers": {
          "Authorization": "Bearer your_ha_token"
      },
      "timeout": 10,
      "sse_read_timeout": 60
  }
}
```

![](https://files.seeedstudio.com/wiki/solution/application/dify-ha-mcp/Dify-MCP-authorize.png)

##### Obtener la direcci√≥n IP de Home Assistant (`your_ha_ip`)

<details>

<summary>Direcci√≥n IP de HA</summary>

Si tu Home Assistant se est√° ejecutando en `http://homeassistant.local:8123`, puedes intentar hacer ping a `homeassistant.local` desde la l√≠nea de comandos de tu computadora para obtener su direcci√≥n IP.

Tambi√©n puedes encontrar la direcci√≥n IP de `homeassistant.local` en la configuraci√≥n de la interfaz de red IPv4 en `http://homeassistant.local:8123/config/network`.

Alternativamente, inicia sesi√≥n en tu Home Assistant; generalmente puedes encontrar su direcci√≥n IPv4 en "Configuraci√≥n" \> "Sistema" \> "Red".

</details>

Asumiendo que tu direcci√≥n actual de Home Assistant es `192.168.101.160`, entonces tu URL SSE ser√°:

```bash
http://192.168.101.160:8123/mcp_server/sse
```

##### Obtener el Token de Acceso de Larga Duraci√≥n de Home Assistant (`your_ha_token`)

Inicia sesi√≥n en tu Home Assistant.

- Haz clic en tu nombre de usuario en la esquina inferior izquierda para ir a tu p√°gina de "Perfil", o ve directamente a [http://homeassistant.local:8123/profile/security](https://www.google.com/search?q=http://homeassistant.local:8123/profile/security).
- Despl√°zate hasta la parte inferior de la p√°gina para encontrar la secci√≥n "Long-Lived Access Tokens".
- Haz clic en "Create Token", dale un nombre (por ejemplo, `Dify_MCP`), y luego haz clic en "OK".
  ![](https://files.seeedstudio.com/wiki/solution/application/dify-ha-mcp/HA-authorize.png)

##### Completar la Configuraci√≥n

Asumiendo que la IP de tu Home Assistant es `192.168.101.160` y el token que obtuviste es `eyJhbGciOi...G4s6IQw` (el token largo real est√° abreviado aqu√≠), entonces la configuraci√≥n JSON completa deber√≠a ser:

```json
{
  "Home Assistant": {
      "url": "http://192.168.101.160:8123/mcp_server/sse",
      "headers": {
          "Authorization": "Bearer eyJhbGciOi...G4s6IQw"
      },
      "timeout": 10,
      "sse_read_timeout": 60
  }
}
```

Copia esta configuraci√≥n JSON completa y p√©gala en el cuadro de entrada de configuraci√≥n de autorizaci√≥n para la herramienta MCP en Dify (reemplazando el contenido de la plantilla original en el cuadro de entrada). Luego, haz clic en "Guardar" o "Aceptar". Si la configuraci√≥n es correcta, deber√≠as ver una notificaci√≥n indicando autorizaci√≥n exitosa o que la herramienta est√° disponible.

Esto te permitir√° llamar a la herramienta MCP en la aplicaci√≥n que creaste.

### ‚Ö°. Escribiendo el Prompt

Un prompt es la instrucci√≥n que le das al Agente de IA, dici√©ndole qu√© papel desempe√±ar, c√≥mo trabajar, y cu√°les son sus capacidades y limitaciones.

  - En el √°rea de configuraci√≥n "**Orquestar**" o "**Prompt**" de tu aplicaci√≥n Agente de Dify, ver√°s un cuadro de texto donde puedes ingresar tu prompt.
  - Para un escenario de hogar inteligente, puedes dise√±ar un prompt simple que le diga a la IA que puede llamar a la herramienta Home Assistant para controlar dispositivos o consultar su estado.

**Un ejemplo de prompt simple**:

```
# Role
You are a helpful smart home assistant.

# Workflow
1. When the user makes a request to control devices in the home (like turning lights on/off, adjusting the air conditioner) or to query device status, you must use the tool named "Home Assistant" to accomplish it.
2. First, analyze the user's intent to determine which device to control and what action to perform.
3. Then, generate the command statement to call the "Home Assistant" tool.
4. If the user is just making small talk, or asks a question unrelated to smart home control, please converse with the user in a friendly manner.

# Requirements
- Your answers should be as concise and clear as possible.
- You can only control devices connected via the "Home-Assistant" tool.
- Clearly inform the user whether the operation was successful or provide the information queried.
```

![](https://files.seeedstudio.com/wiki/solution/application/dify-ha-mcp/dify-app-1.png)


:::tip 

El prompt anterior es un marco muy b√°sico. Puedes modificar y expandir este prompt bas√°ndote en tus dispositivos reales de Home Assistant y las funciones que quieras implementar para adaptarlo mejor a tus necesidades.

Por ejemplo, puedes a√±adir nombres de dispositivos m√°s espec√≠ficos, √°reas de habitaciones, o incluso establecer una "personalidad" espec√≠fica para la IA.

La funci√≥n de orquestaci√≥n de prompts de Dify es muy poderosa, soportando caracter√≠sticas avanzadas como variables, contexto y bases de conocimiento. Puedes consultar la [documentaci√≥n oficial de Dify](https://docs.dify.ai/zh-hans/introduction) y aprender sobre [Ingenier√≠a de Prompts](https://www.promptingguide.ai/zh) para construir aplicaciones de IA m√°s poderosas.

:::

Despu√©s de escribir y guardar tu prompt, ¬°tu aplicaci√≥n de hogar inteligente con IA est√° esencialmente configurada!

## Prob√°ndolo

Ahora, toma tu SenseCAP Watcher, intenta hablarle, y ve si tu asistente de hogar inteligente con IA puede responder correctamente a tus comandos y controlar tus dispositivos inteligentes a trav√©s de Home Assistant!

Por ejemplo, puedes intentar decir: "Enciende la luz de la sala," o "¬øCu√°l es la temperatura en el dormitorio ahora mismo?" (Esto asume que ya has configurado estos dispositivos en Home Assistant y que tu prompt y Agente de Dify pueden entender y procesar correctamente estos comandos).

<center>
<Tweet id="1910315965675712738" /> 
</center>

## Referencias

- [Xiaozhi AI Chatbot](https://github.com/78/xiaozhi-esp32)
- [Xiaozhi Backend Service](https://github.com/xinnan-tech/xiaozhi-esp32-server)
- [Dify](https://docs.dify.ai/zh-hans/introduction)
- [Home Assistant MCP Server](https://www.home-assistant.io/integrations/mcp_server/)

## Preguntas y Respuestas

<details>

<summary>¬øC√≥mo actualizar xiaozhi-esp32-server?</summary>

Ve a la carpeta donde est√°n almacenados los archivos de Docker del backend del servidor Xiaozhi.

```bash
docker compose -f docker-compose_all.yml down
docker rmi ghcr.nju.edu.cn/xinnan-tech/xiaozhi-esp32-server:server_latest
docker rmi ghcr.nju.edu.cn/xinnan-tech/xiaozhi-esp32-server:web_latest
```

Luego, actualiza el archivo compose (si ha sido actualizado) y descarga los nuevos archivos de imagen.

Opcional: Actualiza los archivos de configuraci√≥n. Para actualizaciones de versiones principales, los archivos de configuraci√≥n pueden diferir. Copia el contenido a continuaci√≥n como tu script de actualizaci√≥n:

```bash
#!/bin/bash

# Generic function to update a file
update_file() {
    local FILE="$1"
    local URL="$2"
    local BACKUP_SUFFIX=$(date +%Y%m%d%H%M%S).bk
    local TEMP_FILE="/tmp/$(basename "$FILE")"

    # Ensure the target directory exists
    local DIR=$(dirname "$FILE")
    [ ! -d "$DIR" ] && mkdir -p "$DIR"

    # If the file doesn't exist, download it directly
    if [ ! -f "$FILE" ]; then
        wget -O "$FILE" "$URL" && echo "$FILE does not exist, downloaded." && return
    fi

    # Download to a temporary file and compare differences
    wget -O "$TEMP_FILE" "$URL" && diff "$FILE" "$TEMP_FILE" >/dev/null && { 
        echo "$FILE has no differences, no update needed."; 
        rm "$TEMP_FILE"; 
        return; 
    }
    echo "$FILE has differences:"
    diff "$FILE" "$TEMP_FILE"

    # Prompt the user whether to overwrite
    echo -n "Overwrite the current file? (y/n): "
    read CONFIRM
    if [ "$CONFIRM" != "y" ]; then
        echo "Update for $FILE canceled."
        rm "$TEMP_FILE"
        return
    fi

    # Back up the old file and replace it
    cp "$FILE" "$FILE.$BACKUP_SUFFIX" && mv "$TEMP_FILE" "$FILE" && echo "$FILE has been updated and backed up as $FILE.$BACKUP_SUFFIX"
}

# Update data/.config.yaml
CONFIG_FILE="data/.config.yaml"
CONFIG_URL="https://raw.githubusercontent.com/xinnan-tech/xiaozhi-esp32-server/refs/heads/main/main/xiaozhi-server/config_from_api.yaml"
update_file "$CONFIG_FILE" "$CONFIG_URL"

# Update docker-compose_all.yml
DOCKER_COMPOSE_FILE="docker-compose_all.yml"
DOCKER_COMPOSE_URL="https://raw.githubusercontent.com/xinnan-tech/xiaozhi-esp32-server/refs/heads/main/main/xiaozhi-server/docker-compose_all.yml"
update_file "$DOCKER_COMPOSE_FILE" "$DOCKER_COMPOSE_URL"

echo "All file updates are complete!"
```

```bash
docker compose -f docker-compose_all.yml up -d
```

</details>
